#!/usr/bin/exec-suid --real --environ=none -- /usr/local/bin/python -I

import base64
import hashlib
import os
import random
import shutil
import tempfile
from urllib.parse import quote

from flask import Flask, make_response, redirect, render_template, request
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service

app = Flask(__name__)

with open("/flag", "r") as f:
    flag = f.read().strip()

PORT = 80

_rng = random.Random(
    int.from_bytes(hashlib.sha256(flag.encode("utf-8")).digest(), "big")
)
_baseUri = "http://challenge.localhost"


def _generate_nonce() -> str:
    return base64.b64encode(_rng.getrandbits(256).to_bytes(32, "big")).decode("utf-8")


@app.route("/", methods=["GET"])
def index():
    nonce = _generate_nonce()

    message_param = request.args.get(
        "message",
        base64.b64encode("No message yet - send one!".encode("utf-8")).decode("ascii"),
    )

    message = base64.b64decode(message_param, validate=True).decode("utf-8")

    rendered = render_template(
        "index.html",
        nonce=nonce,
        message=message,
    )

    response = make_response(rendered)

    csp = "; ".join(
        [
            "default-src 'none'",
            f"script-src 'nonce-{nonce}'",
            f"style-src 'nonce-{nonce}'",
            "connect-src 'none'",
            "img-src 'none'",
            "media-src 'none'",
            "form-action 'none'",
            "frame-src 'none'",
            "frame-ancestors 'none'",
            "base-uri 'none'",
            "object-src 'none'",
            "navigate-to 'self'",
            "require-trusted-types-for 'script'",
        ]
    )
    response.headers["Content-Security-Policy"] = csp
    response.headers["Referrer-Policy"] = "no-referrer"
    response.headers["X-Content-Type-Options"] = "nosniff"

    return response


@app.route("/report", methods=["GET"])
def bot():
    message_param = request.args.get(
        "message", base64.b64encode("✉️".encode("utf-8")).decode("ascii")
    )
    url = f"{_baseUri}/?message={quote(message_param, safe='')}"

    old_umask = os.umask(0o077)
    profile_dir = tempfile.mkdtemp(prefix="chromium-profile-")
    os.umask(old_umask)

    options = Options()
    options.add_argument("--headless")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument(f"--user-data-dir={profile_dir}")
    options.binary_location = "/usr/bin/chromium"
    service = Service("/usr/bin/chromedriver")
    driver = None

    try:
        driver = webdriver.Chrome(service=service, options=options)
        driver.get(f"{_baseUri}/")
        driver.add_cookie(
            {
                "name": "token",
                "value": flag,
                "path": "/",
            }
        )

        driver.get(url)
        driver.implicitly_wait(5)
    finally:
        if driver is not None:
            driver.quit()
        shutil.rmtree(profile_dir, ignore_errors=True)

    return redirect(
        f"{_baseUri}/?message={quote(base64.b64encode('Message reported to admin!'.encode('utf-8')).decode('ascii'), safe='')}",
        code=302,
    )


if __name__ == "__main__":
    app.run(port=PORT, debug=False, host="127.0.0.1")
